version: 3

# Define a YAML anchor for common project settings to avoid repetition.
x-project-defaults: &project_defaults
  workflow: conftest
  apply_requirements: [approved]
  autoplan:
    when_modified: ["*.tf", "*.tfvars", "**/modules/**/*.tf", "../../modules/**/*.tf", "../../../modules/**/*.tf"]
    enabled: true

workflows:
  conftest:
    plan:
      steps:
        - init
        - plan
        - show
        # This command is from your original config.yaml
        - run: conftest test --all-namespaces -p policy/ -
    apply:
      steps: [apply]

projects:
# =========================================================================
# Initial Bootstrap Setup - Need to run from local as atlansis is not setup
# =========================================================================
# - name: initial-setup
#   dir: Initial-setup
#   workspace: default
#   autoplan:
#     when_modified: ["*.tf", "*.tfvars"]
#     enabled: true

# =========================================================================
# Team: team-ops
# =========================================================================
- name: team-ops-dev
  dir: terraform/teams/team-ops/dev
  workspace: default
  <<: *project_defaults

- name: team-ops-prod
  dir: terraform/teams/team-ops/prod
  workspace: default
  <<: *project_defaults

# =========================================================================
# Team: team-data
# =========================================================================
- name: team-data-dev
  dir: terraform/teams/team-data/dev
  workspace: default
  <<: *project_defaults

# =========================================================================
# Global Resources
# =========================================================================
- name: global-org-policies
  dir: terraform/global/org-policies
  workspace: default
  <<: *project_defaults
