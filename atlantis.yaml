# Define workflows used in this repo
workflows:
  conftest:
    plan:
      steps:
        - init
        - plan
        - show
        # This command runs Conftest to check policies
        - run: conftest test --all-namespaces -p policy/ -
    apply:
      steps:
        - apply

# Repository configuration
repos:
  - id: github.com/mailamiton/gcp-infra-using-terraform
    # Default workflow and allowed overrides for this repo
    workflow: conftest
    allowed_overrides: [workflow, apply_requirements]

    # Projects define different Terraform root modules and their configurations
    projects:
      # =========================================================================
      # Team: team-ops
      # =========================================================================
      - name: team-ops-dev
        dir: terraform/teams/team-ops/dev
        workspace: default
        autoplan:
          when_modified:
            - "*.tf"
            - "*.tfvars"
            - "**/modules/**/*.tf"
            - "../../modules/**/*.tf"
            - "../../../modules/**/*.tf"
          enabled: true

      - name: team-ops-prod
        dir: terraform/teams/team-ops/prod
        workspace: default
        autoplan:
          when_modified:
            - "*.tf"
            - "*.tfvars"
            - "**/modules/**/*.tf"
            - "../../modules/**/*.tf"
            - "../../../modules/**/*.tf"
          enabled: true

      # =========================================================================
      # Team: team-data
      # =========================================================================
      - name: team-data-dev
        dir: terraform/teams/team-data/dev
        workspace: default
        autoplan:
          when_modified:
            - "*.tf"
            - "*.tfvars"
            - "**/modules/**/*.tf"
            - "../../modules/**/*.tf"
            - "../../../modules/**/*.tf"
          enabled: true

      # =========================================================================
      # Global Resources
      # =========================================================================
      - name: global-org-policies
        dir: terraform/global/org-policies
        workspace: default
        autoplan:
          when_modified:
            - "*.tf"
            - "*.tfvars"
            - "**/modules/**/*.tf"
            - "../../modules/**/*.tf"
            - "../../../modules/**/*.tf"
          enabled: true
